name: Deploy website to GitHub Pages

env:
    NODE_VERSION: "25"
    BASE_URL: "https://filaco.dev"

on:
    # Trigger the workflow every time you push to the `master` branch
    push:
        branches: ["master"]
    # Allows you to run this workflow manually from the Actions tab on GitHub
    workflow_dispatch:

# Provide permission to clone the repo and deploy it to GitHub Pages
permissions:
    contents: read

jobs:
    # Build website
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  # Fetch history for Hugo's .GitInfo and .Lastmod
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: Get Hugo Version
              id: hugo-version
              run: |
                  VERSION=$(grep "hugo_version" hugoblox.yaml | awk '{print $2}' | tr -d "'\"")
                  echo "HUGO_VERSION=$VERSION" >> $GITHUB_ENV

            - name: Install dependencies
              run: |
                  # Install Tailwind CLI if package.json exists
                  if [ -f "package.json" ]; then
                    echo "Installing Tailwind dependencies..."
                    npm ci
                  fi

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                  hugo-version: ${{ env.HUGO_VERSION }}
                  extended: true

              # Cache dependencies (Go modules, node_modules) - stable, rarely changes
            - uses: actions/cache@v4
              with:
                  path: |
                      /tmp/hugo_cache_runner/
                      node_modules/
                      modules/*/node_modules/
                  key: ${{ runner.os }}-hugo-deps-${{ hashFiles('**/go.mod', '**/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-hugo-deps-

              # Cache Hugo resources (processed images, CSS) - invalidates only when assets/config change
            - uses: actions/cache@v4
              with:
                  path: resources/
                  key:
                      ${{ runner.os }}-hugo-resources-${{ hashFiles('assets/**/*', 'config/**/*',
                      'hugo.yaml', 'package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-hugo-resources-

            - name: Build with Hugo
              env:
                  HUGO_ENVIRONMENT: production
              run: |
                  echo "Hugo Cache Dir: $(hugo config | grep cachedir)"
                  hugo --minify --baseURL ${{ env.BASE_URL }}

            - name: Generate Pagefind search index (if applicable)
              run: |
                  # Check if site uses Pagefind search
                  if [ -f "package.json" ] && grep -q "pagefind" package.json; then
                    npx pagefind --source "public"
                  fi

            - name: Upload artifact
              uses: actions/upload-pages-artifact@v4
              with:
                  path: ./public
